<canvas id="ctx" width="500" height="500" style="border:1px solid #000000;"></canvas>

<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.0.3/socket.io.js"></script>
<script>
	var username;
	do{
		username = prompt("Ingresa tu nickname.");
	}while(username == null || username == '');
		
	var ctx = document.getElementById("ctx").getContext("2d");
	ctx.font = '10px Arial';
	
	var socket = io();
	
	var Player = function(initPack){
		var self = {};
		self.id = initPack.id;
		self.name = initPack.name;
		self.x = initPack.x;
		self.y = initPack.y;
		self.score = initPack.score
		
		self.draw = function(){
			
			ctx.fillText(self.name, self.x, self.y - 40);
			ctx.fillText("ptos:" + self.score, self.x, self.y + 25);
		}
		
		Player.list[self.id] = self;
		return self;
	}
	
	var Ball = function(initPack){
		var self = {};
		self.id = initPack.id;
		self.x = initPack.x;
		self.y = initPack.y;
		
		self.draw = function(){
			ctx.fillRect(self.x-5, self.y-5, 10, 10);
		}
		
		Ball.list[self.id] = self;
		return self;
	}
	
	Ball.list = {};
	
	Player.list = {};
	
	socket.on('init', function(data){
		for(var i = 0; i < data.player.length; i++){
			new Player(data.player[i]);
		}
		for(var i = 0; i < data.ball.length; i++){
			new Ball(data.ball[i]);
		}
	});
	
	socket.on('update', function(data){
		for(var i = 0; i < data.player.length; i++){
			var pack = data.player[i];
			var p = Player.list[pack.id];
			if(p){
				if(pack.x != undefined){
					p.x = pack.x;
				}
				if(pack.y != undefined){
					p.y = pack.y;
				}
				if(pack.score != undefined){
					p.score = pack.score;
				}
			}
		}
		for(var i = 0; i < data.ball.length; i++){
			var pack = data.ball[i];
			var b = Ball.list[pack.id];
			if(b){
				if(pack.x != undefined){
					b.x = pack.x;
				}
				if(pack.y != undefined){
					b.y = pack.y;
				}
			}
		}
	});
	
	socket.on('remove', function(data){
		for(var i = 0; i < data.player.length; i++){
			delete Player.list[data.player[i]];
		}
		for(var i = 0; i < data.ball.length; i++){
			delete Ball.list[data.ball[i]];
		}
	});
	
	socket.emit('name', {name:username});
	
	var MAX_X_LENGHT = 500;
	var MAX_Y_LENGHT = 500;
	
	setInterval(function(){
		ctx.clearRect(0, 0, 500, 500);
		for(var i in Player.list){
			Player.list[i].draw();
		}
		for(var i in Ball.list){
			Ball.list[i].draw();
		}
	}, 40);
	
	document.onkeydown = function(event){
		switch(event.keyCode){
			case 68: //d
				socket.emit('keyPress', {inputId:'right', state:true});
				break;
			case 83: //s
				socket.emit('keyPress', {inputId:'down', state:true});
				break;
			case 65: //a
				socket.emit('keyPress', {inputId:'left', state:true});
				break;
			case 87: //w
				socket.emit('keyPress', {inputId:'up', state:true});
				break;
			default:
				break;
		};
	}
	document.onkeyup = function(event){
		switch(event.keyCode){
			case 68: //d
				socket.emit('keyPress', {inputId:'right', state:false});
				break;
			case 83: //s
				socket.emit('keyPress', {inputId:'down', state:false});
				break;
			case 65: //a
				socket.emit('keyPress', {inputId:'left', state:false});
				break;
			case 87: //w
				socket.emit('keyPress', {inputId:'up', state:false});
				break;
			default:
				break;
		};
	}
	
	document.onmousedown = function(event){
		socket.emit('keyPress', {inputId:'attack', state:true});
	}
	
	document.onmouseup = function(event){
		socket.emit('keyPress', {inputId:'attack', state:false});
	}
	
	document.onmousemove= function(event){
		var x = -250 + event.clientX - 8;
		var y = -250 + event.clientY - 8;
		var angle = Math.atan2(y,x)/Math.PI * 180;
		socket.emit('keyPress', {inputId:'mouseAngle', state:angle});
	}
</script>
